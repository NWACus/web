# Persistent Environments Setup and File Storage Implications

Date: 2025-07-17

Status: proposed

## Context

Up to now we've been blowing away each environment's database, creating a new one, and re-seeding it with our seed script on each deploy. This has been nice because our database schema has been changing significantly.

We need to have a persistent production environment and we're at the point where our database schema is more stable and new changes will likely be additions rather than modifications of the existing schema.

Testing new code changes against production data provides certainty and is a good check before deploying to production. We can also validate that our migrations run correctly against production data.

We also have to consider file storage across environments. Up to now we've been using a single Vercel Blob store for all environments. This means that changing an image in one environment might affect the others.

## Decision

### Environments

We have three environments/environment groups:

| Environment | Description | Branch |
|-------------|-------------|--------|
| prod | Our production environment | `release` |
| dev | Our dev environment which mirrors prod data via an update process. See [`sync-prod-to-dev`](../../.github/workflows/sync-prod-to-dev.yml). | `main` |
| preview | An environment group representing our Vercel preview environments | Any branch other than `release` and `main` |

We also have our local environments of course.

#### Key steps during deploys for each env

prod
- runs database migrations and continues to use the `payloadcms-prod` database.

dev
- deletes old `payloadcms-dev` database
- creates a new `payloadcms-dev` database by copying `payloadcms-prod`
- sanitizes the copied database
- syncs `prod` prefix to `dev` prefix in Vercel Blob store
- updates the media prefix to `dev`
- runs database migrations

preview
- creates a new db for the branch
- seeds the db using the seed script

The preview environment workflow is unchanged from our previous workflow.

The intent of the preview environment is to allow devs to make changes to the seed script to demonstrate changes they have made in their branch. Copying prod data might make that difficult to do.

#### Database sanitization

When the prod database is copied to dev a sanitization script is run. This script:
- Changes all user emails to variations of the default replyTo email address in the format: developer+{original_email}@nwac.us. This results in emails being sent to developer@nwac.us since plus addressing delivers emails to the address prior to the plus but still displays the entire email address.
- Changes all passwords to a pre-generated password (the `PAYLOAD_SEED_PASSWORD`)
- Clears all users' reset password token and invite token

The main reasoning behind this is to avoid any issues where production users get emails or links from dev and it isn't clear that they're not working with the prod environment.

The likelihood of this is fairly low right now because we only send emails for auth-related activities (invites and password resets specifically) but could be more of an issue in the future.

Passwords are changed for all users to a single pre-generated password to restrict prod users from logging in to dev with their prod passwords.

### File storage

We'll continue to use a single Vercel Blob store with environment-specific [prefixes](https://payloadcms.com/docs/upload/storage-adapters#plugin-options:~:text=Access%20Control.%20More-,prefix,images%20to%20upload%20files%20inside%20media/images%20folder%20in%20the%20bucket.,-generateFileURL).

Each environment will have their own prefix. This prefix is generated by the [`generateEnvironmentFriendlyName`](../../src/utilities/getEnvironmentFriendlyName.ts) function.

Using prefixes allows us to copy all blobs from one environment to another without incurring data egress/ingress cost and is a simple solution to implement.

The prefix used during upload is stored in the database with each row in the media table. This is the only thing that needs to be updated to point copied media at the appropriate environment's files since media are stored with relative URLs (filenames actually).

The [`sync-prod-to-dev`](../../.github/workflows/sync-prod-to-dev.yml) workflow shows the process for copying files from one environment to another:
1. Copy db
2. Sanitize db
3. Sync blobs between prefixes
4. Update media's prefix column in db

Scripts for steps 2-4 can be run locally via package.json scripts.

## Consequences

The dev environment becomes a mirror of production and not a "persistent" environment in the sense that changes made there will persist

`generateEnvironmentFriendlyName` will output "local" in your local environment. If you have `VERCEL_BLOB_READ_WRITE_TOKEN` set locally your media will be stored in the "local" prefix. This means that two developers' local environments would be using the same Vercel Blob prefix and pointing to the same files. This could result in some issues so just be aware of this if using `VERCEL_BLOB_READ_WRITE_TOKEN` locally. Most of the time it makese sense to just use local file storage in your local env so this shouldn't be a problem.

Since the database sanitization script changes all users' passwords to a single pre-generated password, we should be careful with sharing this password among the team.

If we ever implement the [API key](https://payloadcms.com/docs/authentication/api-keys) strategy, we should update the database sanitization script to delete prod api keys.
