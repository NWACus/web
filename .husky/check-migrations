#!/usr/bin/env sh

# Check for new or modified migration .ts files
MIGRATION_TS_FILES=$(git diff --cached --name-only --diff-filter=AM | grep "^src/migrations/.*\.ts$" | grep -v "index.ts")

if [ -n "$MIGRATION_TS_FILES" ]; then
  echo "üîç Migration .ts files detected in commit, running safety checks..."

  for file in $MIGRATION_TS_FILES; do
    echo "\nChecking: $file"
    pnpm run migrate:check -- "$(basename $file)"

    if [ $? -ne 0 ]; then
      echo "\n‚ö†Ô∏è  Migration safety check failed!"
      echo "Review the warnings above. To commit anyway, use: git commit --no-verify"
      exit 1
    fi
  done

  echo "\n‚úÖ Migration safety checks passed"
fi

# Check for new or modified migration .json snapshot files
MIGRATION_JSON_FILES=$(git diff --cached --name-only --diff-filter=AM | grep "^src/migrations/.*\.json$")

if [ -n "$MIGRATION_JSON_FILES" ]; then
  echo "\nüîç Migration snapshot files detected, checking for regressions..."
  pnpm run migrate:check-snapshots
  echo "\n‚úÖ Snapshot consistency check complete"
fi
