name: cleanup
on:
  workflow_run:
    workflows: ['CI', 'preview']
    types: [completed]
  delete:
jobs:
  cleanup:
    if: ${{ github.event_name == 'workflow_dispatch' || (!contains(fromJson('["main", "release"]'), github.event.ref)) }}
    runs-on: ubuntu-latest
    steps:
      - name: Install Turso CLI
        run: curl -sSfL https://get.tur.so/install.sh | bash
        env:
          TURSO_INSTALL_SKIP_SIGNUP: 'true'

      # - name: Delete preview database
      #   run: |
      #     set -o errexit
      #     set -o nounset
      #     set -o pipefail

      #     ref="${{ github.event.ref }}"
      #     branch="${ref##refs/heads/}"
      #     clean_branch="${branch//[^a-z0-9\-]/x}"

      #     # Truncate ref to a prefix + hash suffix to avoid collisions while maintaining readability
      #     # and ensuring total database name stays within 58 character limit
      #     # "payloadcms-preview-" is 19 characters, leaving 39 for the branch
      #     if [ ${#clean_branch} -gt 39 ]; then
      #       prefix="${clean_branch:0:31}"
      #       hash=$(echo -n "${clean_branch}" | sha256sum | cut -c1-7)
      #       clean_branch="${prefix}-${hash}"
      #     fi

      #     name="payloadcms-preview-${clean_branch}"
      #     echo "[INFO] Attempting to delete database ${name}"

      #     # Switch to the correct organization
      #     /home/runner/.turso/turso org switch nwac

      #     # Check if database exists before attempting to delete
      #     if /home/runner/.turso/turso db show "${name}" >/dev/null 2>&1; then
      #       echo "[INFO] Database ${name} exists, deleting..."
      #       /home/runner/.turso/turso db destroy --yes "${name}"
      #       echo "[INFO] Successfully deleted database ${name}"
      #     else
      #       echo "[ERROR] Database ${name} does not exist, expected it to be there for cleanup"
      #       exit 1
      #     fi
      #   env:
      #     TURSO_API_TOKEN: ${{ secrets.TURSO_API_TOKEN }}

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Remove Vercel Environment Variables
        run: |
          set -o errexit
          set -o nounset
          set -o pipefail

          ref="${{ github.event.ref }}"
          echo "[DEBUG] Raw ref: ${ref}"

          branch="${ref##refs/heads/}"
          echo "[DEBUG] Extracted branch: ${branch}"

          # Safety check: never delete from production
          echo "[DEBUG] Checking if branch is protected (main or release)"
          if [ "$branch" = "main" ] || [ "$branch" = "release" ]; then
            echo "[ERROR] Refusing to delete environment variables from production branch: ${branch}"
            exit 1
          fi
          echo "[DEBUG] Branch check passed, proceeding with cleanup"

          ENV_VARS=(
            "DATABASE_URI"
            "DATABASE_AUTH_TOKEN"
            "PAYLOAD_SEED_PASSWORD"
            "NEXT_PUBLIC_ROOT_DOMAIN"
          )

          echo "[INFO] Removing environment variables for branch: ${branch}"
          echo "[DEBUG] VERCEL_ORG_ID: $VERCEL_ORG_ID"
          echo "[DEBUG] VERCEL_PROJECT_ID: $VERCEL_PROJECT_ID"

          for VAR in "${ENV_VARS[@]}"; do
            echo "[DEBUG] Running: vercel env rm \"$VAR\" preview \"$branch\""
            echo "[INFO] Removing environment variable: $VAR"
            # vercel env rm "$VAR" preview "$branch" --yes --token=${{ secrets.VERCEL_TOKEN }} || echo "[WARN] Variable $VAR not found or already removed"
          done
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Remove Vercel Deployments and Aliases
        run: |
          set -o errexit
          set -o nounset
          set -o pipefail

          ref="${{ github.event.ref }}"
          echo "[DEBUG] Raw ref: ${ref}"

          branch="${ref##refs/heads/}"
          echo "[DEBUG] Extracted branch: ${branch}"

          # Safety check: never delete from production
          echo "[DEBUG] Checking if branch is protected (main or release)"
          if [ "$branch" = "main" ] || [ "$branch" = "release" ]; then
            echo "[ERROR] Refusing to delete deployments from production branch: ${branch}"
            exit 1
          fi
          echo "[DEBUG] Branch check passed, proceeding with cleanup"

          echo "[INFO] Finding deployments for branch: ${branch}"
          echo "[DEBUG] VERCEL_ORG_ID: $VERCEL_ORG_ID"
          echo "[DEBUG] VERCEL_PROJECT_ID: $VERCEL_PROJECT_ID"
          echo "[DEBUG] Running: vercel deployments --json"

          # Get all deployments and filter by branch
          DEPLOYMENTS=$(vercel deployments --json --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null | jq -r ".deployments[] | select(.meta.githubCommitRef==\"$branch\") | .uid" || echo "")

          echo "[DEBUG] Deployments found: ${DEPLOYMENTS}"
          echo "[DEBUG] Deployment count: $(echo "$DEPLOYMENTS" | wc -w)"

          if [ -z "$DEPLOYMENTS" ]; then
            echo "[WARN] No deployments found for branch: ${branch}"
          else
            echo "[INFO] Found deployments: $DEPLOYMENTS"

            # Remove aliases first (they're tied to deployment IDs)
            for DEPLOYMENT_ID in $DEPLOYMENTS; do
              echo "[DEBUG] Processing deployment: $DEPLOYMENT_ID"
              echo "[INFO] Removing aliases for deployment: $DEPLOYMENT_ID"
              ALIASES=$(vercel alias ls --json --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null | jq -r ".aliases[] | select(.deploymentId==\"$DEPLOYMENT_ID\") | .alias" || echo "")

              echo "[DEBUG] Aliases found for $DEPLOYMENT_ID: ${ALIASES}"

              if [ -z "$ALIASES" ]; then
                echo "[WARN] No aliases found for deployment: $DEPLOYMENT_ID"
              else
                for ALIAS in $ALIASES; do
                  echo "[DEBUG] Running: vercel alias remove \"$ALIAS\""
                  echo "[INFO] Removing alias: $ALIAS"
                  # vercel alias remove "$ALIAS" --token=${{ secrets.VERCEL_TOKEN }} --yes || echo "[WARN] Failed to remove alias: $ALIAS"
                done
              fi
            done

            # Then remove deployments
            for DEPLOYMENT_ID in $DEPLOYMENTS; do
              echo "[DEBUG] Running: vercel remove \"$DEPLOYMENT_ID\""
              echo "[INFO] Removing deployment: $DEPLOYMENT_ID"
              # vercel remove "$DEPLOYMENT_ID" --token=${{ secrets.VERCEL_TOKEN }} --yes || echo "[WARN] Failed to remove deployment: $DEPLOYMENT_ID"
            done
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
